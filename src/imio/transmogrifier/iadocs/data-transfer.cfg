# Prerequis:
# créer utilisateur csvimport
# régler les numéros initiaux de fiches

# mandatory section !
[config]
# needed if contact encoding group is enabled in Plone
creating_group =
raise_on_error = 1
internal_number_behavior_types = organization person held_position dmsincomingmail dmsincoming_email
data_transfer_behavior_types = dmsincomingmail dmsincoming_email
none_value = NULL
creator = csvimport
# CHANGE l_1_type_insert FOR EACH CUSTOMER

[transmogrifier]
pipeline =
    initialization
    a_service_match_read
    a_service_match_store
    a_1_service_read
#    a_1_service_check
    a_plone_service_write
    a_service_match_write
    a_service_update
# bb
    b_mailtype_match_read
    b_1_mailtype_match_check
    b_mailtype_match_store
    b_1_mail_read
#    b_1_mail_reject
    b_1_used_nature_store
    b_1_used_source_store
    b_1_mailtype_read
    b_mailtype_used_only
    b_1_mailtype_check
    b_plone_mailtype_write
    b_1_mailtype_by_type
    b_mailtype_match_write
    b_mailtype_update
# cc
    c_1_user_match_read
    c_user_match_store
    c_1_user_read
    c_plone_user_write
    c_1_user_match_write
# dd
    d_need_c
    d_1_contacts_read
    d_1_contacts_uid_only
    d_1_contacts_store
    d_1_mail_read
    d_1_S_only
    d_om_sender_creation
# ee
    e_category_full_match_read
    e_category_full_match_store
    e_category_match_read
    e_1_mail_read
    e_1_folder_read
    e_1_category_reject
    e_1_store_used_category
    e_1_category_read
    e_1_category_code_modify
    e_1_category_check
    e_category_used_only
#    e_category_not_in_plone
    e_plone_category_write
    e_category_matched_add
    e_category_match_write
    e_category_update
    e_category_full_match_write
# ff
#    f_folder_match_read
#    f_folder_match_store
    f_1_folder_read
    f_1_folder_check
    f_folder_matched_uid_add
    f_folder_matched_folder_info_add
    f_folder_service_uid_add
    f_folder_service_name_add
    f_plone_folder_write
    f_folder_match_write

# ll
    l_need
    l_1_contacts_read
    l_1_contacts_check
    l_1_contacts_store
    l_1_mail_read
    l_pickle
    l_1_E_only
    l_batched
    l_count
    l_1_mail_check
    l_1_modification_date_insert
    l_1_internal_number_insert
    l_1_comblain_service_id_correct
    l_treating_groups_insert
    l_1_category_id_insert
    l_1_contact_as_text
    l_mail_type_insert
    l_1_nature_insert
    l_mail_type2_insert
    l_1_source_insert
    l_1_meetingitem_link_insert
    l_1_confidential_insert
    l_1_remark_insert
    l_1_type_insert
    l_1_parent_insert
    l_1_path_insert
    count1
#    continue
    creators_insert
    constructor
#    1_service_correct
    schemaupdater
    datesupdater
    l_state_set
    reindexobject
    workflowupdater
    count2
    post_actions
    breakpoint
    short_log
    lastsection

[disable_versioning]
blueprint = plone.app.transmogrifier.versioning.disable

[initialization]
blueprint = imio.transmogrifier.iadocs.init
# basepath is an absolute directory. If empty, buildout dir will be used
basepath =
# if subpath, it will be appended to basepath
subpath = imports
# if empty it will be subpath full path
csvpath = source1_dir

[a_service_match_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: modules['os'].path.exists(filename)
# filename is relative to csvpath
filename = 1_service_match.csv
fieldnames = eid eparent etitle uid title
bp_key = e_service_match
# none_value = ${config:none_value}
# csv_headers = python:True
# csv_encoding = utf8
# dialect = excel
# fmtparam-strict = python:True
# fmtparam-delimiter = python:','
# raise_on_error = ${config:raise_on_error}

[a_service_match_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_service_match'
bp_key = e_service_match
store_key = eid
fieldnames = etitle uid title
yield = 0

[a_1_service_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('a_service_match_read', {}).get('filename', '_not_found_')))
filename = eServices.csv
fieldnames = _A _eid _title _pid _E _F _G _H _I _J _code _L _M _N _O _P _Q _R _S _T _U _V _W _X _Y _Z _AA _AB _AC _AD _AE _AF _AG _AH _AI _AJ _AK _AL _AM _AN _AO _AP _AQ _AR
bp_key = e_service

[a_1_service_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_service
condition = python: item.get('_bpk') == u'e_service'
raise_on_error = ${config:raise_on_error}

[a_plone_service_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('a_service_match_read', {}).get('filename', '_not_found_')))
filename = 0_imio_service.csv
fieldnames = uid ft t
headers = uid full_title title
bp_key = p_orgs_all
# if store_key, the printed value is not the item but the values in storage['data'][{bp_key}]. The key is considered as store_key field
store_key = uid
store_key_sort = ft

[a_service_match_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('a_service_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_service'
filename = 0_service_match.csv
fieldnames = _eid _pid title
headers = eid parent_eid etitle uid full_title
bp_key = 0_service_match

[a_service_update]
blueprint = imio.transmogrifier.iadocs.a_service_update
condition = python: item.get('_bpk') == u'e_service'

[b_mailtype_match_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: modules['os'].path.exists(filename)
filename = 1_mailtype_match.csv
fieldnames = _eid _etype _etitle _enature _esource _c_type _key _title _active
bp_key = e_mailtype_match

[b_1_mailtype_match_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_mailtype_match
condition = python: item.get('_bpk') == u'e_mailtype_match'
booleans = _enature _esource _active

[b_mailtype_match_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_mailtype_match'
bp_key = e_mailtype_match
store_key = _eid
store_subkey = _etype
fieldnames = _enature _esource _etitle _c_type _key _title _active
yield = 1

[b_1_mail_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('b_mailtype_match_read', {}).get('filename', '_not_found_')))
filename = eCourriers.csv
fieldnames = _A _eid _C reception_date original_mail_date external_reference_no due_date _nature_id _sender_id _sender _service title _remark _etype _O classification_categories _Q _R _S _T _U _to_del _W _source _source_id _Z _AA _AB _AC _AD _AE _AF _AG _AH _AI _AJ _AK _AL _AM _AN _AO _AP _AQ _AR _AS _AT _AU _AV _AW _AX _AY _AZ _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _version _BL _BM
bp_key = e_mail_mailtype

[b_1_mail_reject]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == 'e_mail_mailtype'
condition2 = python: item.get('_bpk') in ('E', 'S') and str(item['_to_del']) != '1'

[b_1_used_nature_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_mail_mailtype'
bp_key = e_used_mailtype
store_key = _nature_id
store_subkey = _etype
fieldnames = _eid
yield = 1

[b_1_used_source_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_mail_mailtype'
bp_key = e_used_mailtype
store_key = _source_id
store_subkey = _etype
fieldnames = _eid
yield = 0

[b_1_mailtype_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('b_mailtype_match_read', {}).get('filename', '_not_found_')))
filename = eNatures.csv
fieldnames = _A _eid _etitle _D _nature _source _G _H _I _J _K _L _M _N _O
bp_key = e_mailtype

[b_mailtype_used_only]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_mailtype'
condition2 = python: item.get('_eid') in storage['data'].get('e_used_mailtype', [])

[b_1_mailtype_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_mailtype
condition = python: item.get('_bpk') == u'e_mailtype'
booleans = _nature _source
raise_on_error = ${config:raise_on_error}

[b_plone_mailtype_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('b_mailtype_match_read', {}).get('filename', '_not_found_')))
filename = 0_imio_mailtype.csv
fieldnames = type value dtitle active
headers = type key title active
bp_key = p_mailtype
store_key = type
store_subkey = value
store_key_sort =

[b_1_mailtype_by_type]
blueprint = imio.transmogrifier.iadocs.b_1_mailtype_by_type
condition = python: not storage['data'].get('e_mailtype_match') and item.get('_bpk') == 'e_mailtype'
related_storage = e_used_mailtype

[b_mailtype_match_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('b_mailtype_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_mailtype'
filename = 0_mailtype_match.csv
fieldnames = _eid _etype _etitle _nature _source
headers = eid etype etitle nature source type key title active
bp_key = 0_mailtype_match

[b_mailtype_update]
blueprint = imio.transmogrifier.iadocs.b_mailtype_update
condition = python: item['_bpk'] == u'e_mailtype_match'

[c_1_user_match_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: modules['os'].path.exists(filename)
filename = 1_user_match.csv
fieldnames = _eid _nom _prenom _uid _fullname
bp_key = e_user_match

[c_user_match_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_user_match'
bp_key = e_user_match
store_key = _eid
fieldnames = _nom _prenom _uid _fullname
yield = 0

[c_1_user_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('c_1_user_match_read', {}).get('filename', '_not_found_')))
filename = eUsers.csv
fieldnames = _A _eid _elogin _D _active _F _G _H _I _J _K _L _M _N _O _P _Q _R _S _T _nom _prenom _W _X _Y _Z
             _AA _AB _AC _AD _AE _AF _AG _AH _AI _AJ _AK _AL _AM _AN _AO _AP _AQ _AR _AS _AT _AU _AV _AW _AX _AY _AZ
             _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _BK _BL _BM _BN _BO _BP _BQ _BR _BS _BT _BU _BV _BW _BX _BY _BZ
             _CA _CB _CC _CD _CE _CF _CG _CH _CI _CJ _CK _CL _CM _CN _CO _CP _CQ _CR _CS _CT _CU _CV _CW _CX _CY _CZ
             _DA _DB _DC _DD _DE _DF _DG _DH _DI _DJ _DK _DL _DM _DN _DO _DP _DQ _DR _DS _DT _DU _DV _DW _DX _DY _DZ
             _EA _EB _EC _ED _EE _EF _EG _EH _EI _EJ _EK _EL _EM _EN _EO _EP _EQ _ER _ES _ET _EU _EV _EW _EX _EY _EZ
             _FA _FB _FC _FD _FE _FF _FG _FH _FI _FJ _FK _FL _FM _FN _FO _FP _FQ _FR _FS _FT _FU _FV
bp_key = e_user

[c_plone_user_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('c_1_user_match_read', {}).get('filename', '_not_found_')))
filename = 0_imio_user.csv
fieldnames = uid fullname
headers = uid fullname
bp_key = p_user
store_key = uid
store_key_sort = fullname

[c_1_user_match_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('c_1_user_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_user'
filename = 0_user_match.csv
fieldnames = _eid _nom _prenom
headers = eid nom prenom p_uid p_fullname
bp_key = 0_user_match
yield = 0

[d_need_c]
blueprint = imio.transmogrifier.iadocs.need_other
parts = c

[d_1_contacts_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition =
filename = eContacts.csv
fieldnames = _A _eid _uid _D _E _F _G _H _I _J _K _L _M _N _O _P _Q _R _S _T _U _V _W _X _Y _Z
             _AA _AB _AC _AD _AE _AF _AG _AH _AI _AJ _AK _AL _AM _AN _AO _AP _AQ _AR _AS _AT _AU _AV _AW _AX _AY _AZ
             _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _BK _BL _BM _BN _BO _BP _BQ _BR _BS _BT _BU _BV _BW _BX _BY _BZ
             _CA _CB _CC _CD _CE _CF _CG _CH _CI _CJ _CK _CL _CM _CN _CO _CP _CQ _CR _CS _CT _CU _CV _CW _CX _CY _CZ
             _DA _DB _DC _DD _DE _DF _DG _DH _DI _DJ _DK _DL _DM _DN _DO _DP _DQ _DR _DS _DT _DU _DV _DW _DX _DY _DZ
             _EA _EB _EC _ED _EE _EF _EG _EH _EI _EJ _EK _EL _EM _EN _EO _EP _EQ _ER _ES _ET _EU _EV _EW _EX _EY _EZ
             _FA _FB _FC _FD _FE _FF _FG _FH _FI _FJ _FK _FL _FM _FN _FO
bp_key = e_contacts_sender

[d_1_contacts_uid_only]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_contacts_sender'
condition2 = python: item.get('_uid') is not None

[d_1_contacts_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_contacts_sender'
bp_key = e_contacts_sender
store_key = _eid
fieldnames = _uid
yield = 0

[d_1_mail_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition =
filename = eCourriers.csv
fieldnames = _A _eid _C _D _E _F _G _H _sender_id _sender _service _L _M _etype _O _P _Q _R _S _T _U _V _W _X _Y _Z
             _AA _AB _AC _AD _AE _AF _AG _AH _AI _AJ _AK _AL _AM _AN _AO _AP _AQ _AR _AS _AT _AU _AV _AW _AX _AY _AZ
             _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _BK _BL _BM
bp_key = e_mail_sender

[d_1_S_only]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_mail_sender'
condition2 = python: item.get('_etype') == 'S'

[d_om_sender_creation]
blueprint = imio.transmogrifier.iadocs.d_om_sender_creation
condition = python: item.get('_bpk') == u'e_mail_sender'

[e_category_full_match_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: modules['os'].path.exists(filename)
filename = 2_category_match.csv
fieldnames = _eid _ecode _etitle _eactive _pcode _puid _ptitle _pactive
bp_key = e_category_full_match

[e_category_full_match_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_category_full_match'
bp_key = e_category_full_match
store_key = _eid
fieldnames = _ecode _etitle _pcode _puid
yield = 0

[e_category_match_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: modules['os'].path.exists(filename) and not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_full_match_read', {}).get('filename', '_not_found_')))
filename = 1_category_match.csv
fieldnames = _eid _ecode _etitle _eactive _pcode _puid _ptitle _pactive
bp_key = e_category_match

[e_1_mail_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
filename = eCourriers.csv
fieldnames = _A _eid _C _D _E _F _G _H _I _J _K _L _M _N _O _category_id _Q _R _S _T _U _V _W _X _Y _Z
             _AA _AB _AC _AD _AE _AF _AG _AH _AI _AJ _AK _AL _AM _AN _AO _AP _AQ _AR _AS _AT _AU _AV _AW _AX _AY _AZ
             _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _BK _BL _BM
bp_key = e_mail_category

[e_1_folder_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
filename = eClassementDossiers.csv
fieldnames = _A _eid _C _D _E _F _G _H _I _category_id _K _L _M _N _O _P _Q _R _S _T _U _V _W _X _Y _Z _AA _AB _AC _AD _AE _AF _AG _AH _AI
bp_key = e_folder_category

[e_1_category_reject]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') in (u'e_mail_category', u'e_folder_category')
condition2 = python: item.get('_category_id') not in (None, u'0')

[e_1_store_used_category]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') in (u'e_mail_category', u'e_folder_category')
bp_key = e_used_category
store_key = _category_id
store_subkey = _bpk
fieldnames = _eid
yield = 0

[e_1_category_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition = python: modules['os'].path.exists(filename) and not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
filename = eClassement.csv
fieldnames = _A _eid _C _code _title _eactive _G _H _I _J _K _L
bp_key = e_category

[e_1_category_code_modify]
blueprint = collective.transmogrifier.sections.inserter
condition = python: item.get('_bpk') == u'e_category' and item['_code'].startswith('1.824.508/')
key = string:_code
value = python:item['_code'].replace('/', '.')

[e_1_category_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_category
condition = python: item.get('_bpk') in (u'e_category', u'e_category_match')
strip_chars = _code .
booleans = _eactive

[e_category_used_only]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_category'
condition2 = python: item.get('_eid') in storage['data'].get('e_used_category', [])

[e_category_not_in_plone]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_category'
condition2 = python: item['_code'] not in storage['data'].get('p_category', [])

[e_plone_category_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
filename = 0_imio_category.csv
fieldnames = _pcode uid title enabled
headers = pcode puid ptitle pactive
bp_key = p_category
store_key = _pcode
store_key_sort =
yield = 1

[e_category_matched_add]
blueprint = imio.transmogrifier.iadocs.add_data_in_item
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == u'e_category'
bp_key = e_category_matched_add
related_storage = p_category
store_key = _code
store_subkey =
fieldnames = title uid enabled
prefix = _p

[e_category_match_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_category'
filename = 0_category_match.csv
fieldnames = _eid _code _title _eactive _p_code _puid _ptitle _penabled
headers = eid ecode etitle eactive pcode puid ptitle pactive
bp_key = 0_category_match
yield = 0

[e_category_update]
blueprint = imio.transmogrifier.iadocs.e_category_update
b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_full_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_category_match'
bp_key = e_category_update

[e_category_full_match_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
b_condition = python: storage['commit'] and not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_full_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_category_match'
filename = 2_category_match.csv
fieldnames = _eid _ecode _etitle _eactive _pcode _puid _ptitle _pactive
headers = eid ecode etitle eactive pcode puid ptitle pactive
bp_key = 2_category_match
yield = 0

[f_1_folder_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
filename = eClassementDossiers.csv
fieldnames = _A _eid _title _archive _archive_date _localisation _comment1 _service_id _I _category_id _parent1 _parent2 _M _N _O _P _Q _R _S _T _comment2 _V _W _X _Y _Z _AA _AB _AC _AD _AE _AF _AG _AH _AI
bp_key = e_folder

[f_1_folder_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_folder
condition = python: item.get('_bpk') == u'e_folder'
hyphen_newline = _title _comment1 _comment2
booleans = _archive

[f_folder_matched_uid_add]
blueprint = imio.transmogrifier.iadocs.add_data_in_item
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == u'e_folder'
bp_key = f_folder_matched_uid_add
related_storage = p_irn_to_folder
store_key = _eid
store_subkey =
fieldnames = uid
prefix = _pf
marker = eid_present

[f_folder_matched_folder_info_add]
blueprint = imio.transmogrifier.iadocs.add_data_in_item
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == u'e_folder'
bp_key = f_folder_matched_folder_info_add
related_storage = p_folder_uid
store_key = _pfuid
store_subkey =
fieldnames = full_title parent
prefix = _p
add_store_keys = 0

[f_folder_service_uid_add]
blueprint = imio.transmogrifier.iadocs.add_data_in_item
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == u'e_folder'
bp_key = f_folder_service_uid_add
related_storage = p_eid_to_orgs
store_key = _service_id
store_subkey =
fieldnames = uid
prefix = _ps_

[f_folder_service_name_add]
blueprint = imio.transmogrifier.iadocs.add_data_in_item
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == u'e_folder'
bp_key = f_folder_service_name_add
related_storage = p_orgs_all
store_key = _ps_uid
store_subkey =
fieldnames = ft
prefix = _ps
add_store_keys = 0

[f_folder_match_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
condition = python: item.get('_bpk') == 'e_folder'
filename = 0_folder_match.csv
fieldnames = _eid _title _archive _parent2 _psft _pfuid _pfull_title _pparent _mar_ker
headers = eid etitle earchive eparent eservice puid ptitle pparent origin
bp_key = 0_folder_match
yield = 0

[f_plone_folder_write]
blueprint = imio.transmogrifier.iadocs.csv_writer
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('e_category_match_read', {}).get('filename', '_not_found_')))
filename = 0_imio_folder.csv
fieldnames = _puid title parent irn peid
headers = uid title parent_uid reference_nb eid
bp_key = p_folder_uid
store_key = _puid
store_key_sort =
yield = 1

[l_need]
blueprint = imio.transmogrifier.iadocs.need_other
parts = abce

[l_1_contacts_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
b_condition =
filename = eContacts.csv
fieldnames = _A _eid _uid _ctyp _E _lname _fname _ptitle _street _pc _city _L _phone1 _phone2 _phone3 _P _email1 _email2 _email3 _T _U _V _function _X _Y _Z
             _AA _AB _AC _AD _AE _e_nb _AG _AH _AI _AJ _AK _AL _cell1 _cell2 _cell3 _web _org _name2 _AS _AT _AU _AV _AW _AX _AY _parent_id
             _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _BK _BL _BM _BN _BO _BP _BQ _BR _BS _BT _BU _BV _BW _BX _BY _BZ
             _CA _CB _CC _CD _CE _CF _CG _CH _CI _CJ _CK _CL _CM _CN _CO _CP _CQ _CR _CS _CT _CU _CV _CW _CX _CY _CZ
             _DA _DB _DC _DD _DE _DF _DG _DH _DI _DJ _DK _DL _DM _DN _DO _DP _DQ _DR _DS _DT _DU _DV _DW _DX _DY _DZ
             _EA _EB _EC _ED _EE _EF _EG _EH _EI _EJ _EK _EL _EM _EN _EO _EP _EQ _ER _ES _ET _EU _EV _addr_id _EX _EY _EZ
             _FA _FB _FC _FD _FE _FF _FG _FH _FI _FJ _FK _FL _FM _FN _FO
bp_key = e_contact

[l_1_contacts_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_contact
condition = python: item.get('_bpk') == u'e_contact'
hyphen_newline = _lname _fname _street _city
invalids = _lname 0 -fname 0 _street ",|0, 0|0, 23" _pc 0 _city 0
booleans = _org
raise_on_error = ${config:raise_on_error}

[l_1_contacts_store]
blueprint = imio.transmogrifier.iadocs.store_in_data
condition = python: item.get('_bpk') == u'e_contact'
bp_key = e_contact
store_key = _eid
fieldnames = _uid _ctyp _lname _fname _ptitle _street _pc _city _phone2 _phone2 _phone3 _email1 _email2 _email3 _function _e_nb _cell1 _cell2 _cell3 _web _org _name2 _parent_id _addr_id
yield = 0

[l_1_mail_read]
blueprint = imio.transmogrifier.iadocs.csv_reader
#b_condition = python: not modules['os'].path.exists(modules['imio.transmogrifier.iadocs.utils'].full_path(storage['csvp'], transmogrifier.get('b_mailtype_match_read', {}).get('filename', '_not_found_')))
filename = eCourriers_E_test.csv
#filename = eCourriers.csv
fieldnames = _A _eid _C reception_date original_mail_date external_reference_no due_date _nature_id _sender_id _sender _service_id title _remark _etype _confidential _category_id
             _Q _R _S _T _U _to_del _W _source _source_id _Z
             creation_date _AB _AC _AD _AE _AF _AG _AH _AI _meeting_link _meetingitem_link _AL _AM _AN _AO _AP _AQ _AR _AS _AT _AU _AV _AW _AX _AY _AZ
             _BA _BB _BC _BD _BE _BF _BG _BH _BI _BJ _BK _BL _BM
bp_key = e_mail_i

[l_pickle]
blueprint = imio.transmogrifier.iadocs.pickle_data
filename = 2_e_mail_i.pkl
store_key = e_mail_i
d_condition = python:storage['commit'] is True

[l_1_E_only]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_mail_i'
condition2 = python: item.get('_etype') == 'E'

[l_batched]
blueprint = imio.transmogrifier.iadocs.condition
condition1 = python: name[0:1] in transmogrifier.parts and item.get('_bpk') == u'e_mail_i'
condition2 = python:not storage['batch_nb'] and True or (item['_eid'] not in storage['data']['e_mail_i'] and storage.get('count', {}).get('l_count', {}).get('e_mail_i', {}).get('c', 0) < storage['batch_nb'])

[l_count]
blueprint = imio.transmogrifier.iadocs.count
group_key = _bpk

[l_1_mail_check]
blueprint = imio.transmogrifier.iadocs.common_input_checks
bp_key = e_mail_i
condition = python: item.get('_bpk') == u'e_mail_i'
hyphen_newline = title external_reference_no
invalids = reception_date 0 original_mail_date 0 due_date 0
booleans = _confidential _meetingitem_link
dates = reception_date %Y%m%d 0 original_mail_date %Y%m%d 1 due_date %Y%m%d 0 creation_date %Y%m%d 0

[l_1_modification_date_insert]
blueprint = collective.transmogrifier.sections.manipulator
keys = creation_date
destination = string:modification_date

[l_1_internal_number_insert]
blueprint = collective.transmogrifier.sections.manipulator
keys = _eid
destination = string:internal_number

[l_1_comblain_service_id_correct]
blueprint = collective.transmogrifier.sections.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_category_id'] not in (None, u'0') and item['_service_id'] != u'333'
            and item['_category_id'] >= u'48235' and item['_category_id'] <= u'48271'
key = string:_service_id
value = python:u'333'

[l_treating_groups_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i'
key = string:treating_groups
value = python:storage['data']['e_service_match'][item['_service_id']]['uid']

[l_1_category_id_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_category_id'] not in (None, u'0')
key = string:classification_categories
value = python:[storage['data']['e_category_full_match'][item['_category_id']]['_puid']]
# value = python:item['_category_id'] in storage['data']['e_category_full_match'] and [storage['data']['e_category_full_match'][item['_category_id']]['_puid']] or None

[l_1_contact_as_text]
blueprint = imio.transmogrifier.iadocs.l_1_contact_as_text
condition = python: item.get('_bpk') == u'e_mail_i'

[l_mail_type_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_nature_id']
key = string:mail_type
value = python:storage['data']['e_mailtype_match'][item['_nature_id']]['E']['_key']

[l_1_nature_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_nature_id']
key = string:data_transfer
value = python:u'Nature: {}'.format(storage['data']['e_mailtype_match'][item['_nature_id']]['E']['_etitle'])
separator = python:u'\r\n'

[l_mail_type2_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_source_id'] and 'mail_type' not in item
key = string:mail_type
value = python:storage['data']['e_mailtype_match'][item['_source_id']]['E']['_key']

[l_1_source_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_source_id']
key = string:data_transfer
value = python:u'Source: {}'.format(storage['data']['e_mailtype_match'][item['_source_id']]['E']['_etitle'])
separator = python:u'\r\n'

[l_1_meetingitem_link_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_meetingitem_link']
key = string:data_transfer
value = python:u'Lien avec un point delib.'
separator = python:u'\r\n'

[l_1_confidential_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i' and item['_confidential']
key = string:data_transfer
value = python:u'Courrier confidentiel.'
separator = python:u'\r\n'

[l_1_remark_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_bpk') == u'e_mail_i'
key = string:description
value = python:modules['imio.transmogrifier.iadocs.utils'].clean_value(item['_remark'], patterns=[r'^["\']+$'], osep=u'\r\n')
separator = python:u'\r\n'

[TODO: destinataire]

[l_1_type_insert]
blueprint = collective.transmogrifier.sections.inserter
condition = python: item.get('_bpk') == u'e_mail_i'
key = string:_type
value = python:(item['_source_id'] == u'295' or item['_nature_id'] == u'180') and 'dmsincoming_email' or 'dmsincomingmail'

[l_1_parent_insert]
blueprint = imio.transmogrifier.iadocs.parent_path_insert

[l_1_path_insert]
blueprint = imio.transmogrifier.iadocs.path_insert
condition = python: item.get('_bpk') == u'e_mail_i'
bp_key = e_mail_i
id_keys = _eid

[l_1_temp1_insert]
blueprint = collective.transmogrifier.sections.inserter
condition = python: item.get('_bpk') == u'e_mail_i'
key = string:treating_groups
value = python:modules['zope.annotation.interfaces'].IAnnotations(transmogrifier)['imio.transmogrifier.iadocs']['data']['p_orgs_all'].keys()[0]

[count1]
blueprint = imio.transmogrifier.iadocs.count
group_key = _bpk

[count2]
blueprint = imio.transmogrifier.iadocs.count
group_key = _bpk

[creators_insert]
blueprint = imio.transmogrifier.iadocs.inserter
condition = python: item.get('_type') and item.get('_path')
key = string:creators
value = string:${config:creator}

[constructor]
blueprint = collective.transmogrifier.sections.constructor
# needs _path and _type

[schemaupdater]
blueprint = transmogrify.dexterity.schemaupdater

[datesupdater]
blueprint = plone.app.transmogrifier.datesupdater

[l_state_set]
blueprint = imio.transmogrifier.iadocs.state_set
condition = python: item.get('_bpk') == u'e_mail_i'
workflow_id = incomingmail_workflow
state_id = closed
action_id = close
replace = created
date_key = creation_date
actor = ${config:creator}

[workflowupdater]
blueprint = plone.app.transmogrifier.workflowupdater

[post_actions]
blueprint = imio.transmogrifier.iadocs.post_actions

[reindexobject]
blueprint = plone.app.transmogrifier.reindexobject

[lastsection]
blueprint = imio.transmogrifier.iadocs.last_section

[short_log]
blueprint = imio.transmogrifier.iadocs.short_log

[breakpoint]
# run ipdb if condition is matched
blueprint = imio.transmogrifier.iadocs.breakpoint
# condition = python:item.get('_service_id', u'') == u'333'
condition = python:item.get('_eid', u'') == u'168086'
# condition = python:item.get('_bpk') == u'e_category' and item['_code'].startswith('1.824.508')

[stop]
# raise an error to stop the pipeline
blueprint = imio.transmogrifier.iadocs.stop
condition = python:True

[continue]
# never yield the item to the next section
blueprint = collective.transmogrifier.sections.condition
condition = python:False
